{"version":3,"sources":["/Users/ky/Sites/valet/copesacontent/web/app/plugins/gutenberg/packages/edit-post/src/hooks/components/media-upload/index.js"],"names":["castArray","pick","Component","__","getGalleryDetailsMediaFrame","wp","media","view","MediaFrame","Post","extend","createStates","states","add","controller","Library","id","title","l10n","createGalleryTitle","priority","toolbar","filterable","multiple","editable","library","query","_","defaults","type","options","GalleryEdit","selection","editing","menu","displaySettings","GalleryAdd","slimImageObject","img","attrSet","getAttachmentsCollection","ids","order","orderby","post__in","per_page","MediaUpload","allowedTypes","gallery","modalClass","value","arguments","openModal","bind","onOpen","onSelect","onUpdate","onClose","currentState","GalleryDetailsMediaFrame","attachments","model","Selection","models","props","toJSON","frame","mimeType","state","frameConfig","button","text","$el","addClass","on","remove","selections","selectedImages","get","length","map","attachment","more","open","render"],"mappings":"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","sourcesContent":["/**\n * External Dependencies\n */\nimport { castArray, pick } from 'lodash';\n\n/**\n * WordPress dependencies\n */\nimport { Component } from '@wordpress/element';\nimport { __ } from '@wordpress/i18n';\n\n// Getter for the sake of unit tests.\nconst getGalleryDetailsMediaFrame = () => {\n\t/**\n\t * Custom gallery details frame.\n\t *\n\t * @link https://github.com/xwp/wp-core-media-widgets/blob/905edbccfc2a623b73a93dac803c5335519d7837/wp-admin/js/widgets/media-gallery-widget.js\n\t * @class GalleryDetailsMediaFrame\n\t * @constructor\n\t */\n\treturn wp.media.view.MediaFrame.Post.extend( {\n\n\t\t/**\n\t\t * Create the default states.\n\t\t *\n\t\t * @return {void}\n\t\t */\n\t\tcreateStates: function createStates() {\n\t\t\tthis.states.add( [\n\t\t\t\tnew wp.media.controller.Library( {\n\t\t\t\t\tid: 'gallery',\n\t\t\t\t\ttitle: wp.media.view.l10n.createGalleryTitle,\n\t\t\t\t\tpriority: 40,\n\t\t\t\t\ttoolbar: 'main-gallery',\n\t\t\t\t\tfilterable: 'uploaded',\n\t\t\t\t\tmultiple: 'add',\n\t\t\t\t\teditable: false,\n\n\t\t\t\t\tlibrary: wp.media.query( _.defaults( {\n\t\t\t\t\t\ttype: 'image',\n\t\t\t\t\t}, this.options.library ) ),\n\t\t\t\t} ),\n\n\t\t\t\tnew wp.media.controller.GalleryEdit( {\n\t\t\t\t\tlibrary: this.options.selection,\n\t\t\t\t\tediting: this.options.editing,\n\t\t\t\t\tmenu: 'gallery',\n\t\t\t\t\tdisplaySettings: false,\n\t\t\t\t\tmultiple: true,\n\t\t\t\t} ),\n\n\t\t\t\tnew wp.media.controller.GalleryAdd(),\n\t\t\t] );\n\t\t},\n\t} );\n};\n\n// the media library image object contains numerous attributes\n// we only need this set to display the image in the library\nconst slimImageObject = ( img ) => {\n\tconst attrSet = [ 'sizes', 'mime', 'type', 'subtype', 'id', 'url', 'alt', 'link', 'caption' ];\n\treturn pick( img, attrSet );\n};\n\nconst getAttachmentsCollection = ( ids ) => {\n\treturn wp.media.query( {\n\t\torder: 'ASC',\n\t\torderby: 'post__in',\n\t\tpost__in: ids,\n\t\tper_page: 100,\n\t\tquery: true,\n\t\ttype: 'image',\n\t} );\n};\n\nclass MediaUpload extends Component {\n\tconstructor( {\n\t\tallowedTypes,\n\t\tmultiple = false,\n\t\tgallery = false,\n\t\ttitle = __( 'Select or Upload Media' ),\n\t\tmodalClass,\n\t\tvalue,\n\t} ) {\n\t\tsuper( ...arguments );\n\t\tthis.openModal = this.openModal.bind( this );\n\t\tthis.onOpen = this.onOpen.bind( this );\n\t\tthis.onSelect = this.onSelect.bind( this );\n\t\tthis.onUpdate = this.onUpdate.bind( this );\n\t\tthis.onClose = this.onClose.bind( this );\n\n\t\tif ( gallery ) {\n\t\t\tconst currentState = value ? 'gallery-edit' : 'gallery';\n\t\t\tconst GalleryDetailsMediaFrame = getGalleryDetailsMediaFrame();\n\t\t\tconst attachments = getAttachmentsCollection( value );\n\t\t\tconst selection = new wp.media.model.Selection( attachments.models, {\n\t\t\t\tprops: attachments.props.toJSON(),\n\t\t\t\tmultiple,\n\t\t\t} );\n\t\t\tthis.frame = new GalleryDetailsMediaFrame( {\n\t\t\t\tmimeType: allowedTypes,\n\t\t\t\tstate: currentState,\n\t\t\t\tmultiple,\n\t\t\t\tselection,\n\t\t\t\tediting: ( value ) ? true : false,\n\t\t\t} );\n\t\t\twp.media.frame = this.frame;\n\t\t} else {\n\t\t\tconst frameConfig = {\n\t\t\t\ttitle,\n\t\t\t\tbutton: {\n\t\t\t\t\ttext: __( 'Select' ),\n\t\t\t\t},\n\t\t\t\tmultiple,\n\t\t\t};\n\t\t\tif ( !! allowedTypes ) {\n\t\t\t\tframeConfig.library = { type: allowedTypes };\n\t\t\t}\n\n\t\t\tthis.frame = wp.media( frameConfig );\n\t\t}\n\n\t\tif ( modalClass ) {\n\t\t\tthis.frame.$el.addClass( modalClass );\n\t\t}\n\n\t\t// When an image is selected in the media frame...\n\t\tthis.frame.on( 'select', this.onSelect );\n\t\tthis.frame.on( 'update', this.onUpdate );\n\t\tthis.frame.on( 'open', this.onOpen );\n\t\tthis.frame.on( 'close', this.onClose );\n\t}\n\n\tcomponentWillUnmount() {\n\t\tthis.frame.remove();\n\t}\n\n\tonUpdate( selections ) {\n\t\tconst { onSelect, multiple = false } = this.props;\n\t\tconst state = this.frame.state();\n\t\tconst selectedImages = selections || state.get( 'selection' );\n\n\t\tif ( ! selectedImages || ! selectedImages.models.length ) {\n\t\t\treturn;\n\t\t}\n\n\t\tif ( multiple ) {\n\t\t\tonSelect( selectedImages.models.map( ( model ) => slimImageObject( model.toJSON() ) ) );\n\t\t} else {\n\t\t\tonSelect( slimImageObject( ( selectedImages.models[ 0 ].toJSON() ) ) );\n\t\t}\n\t}\n\n\tonSelect() {\n\t\tconst { onSelect, multiple = false } = this.props;\n\t\t// Get media attachment details from the frame state\n\t\tconst attachment = this.frame.state().get( 'selection' ).toJSON();\n\t\tonSelect(\n\t\t\tmultiple ?\n\t\t\t\tattachment :\n\t\t\t\tattachment[ 0 ]\n\t\t);\n\t}\n\n\tonOpen() {\n\t\tif ( ! this.props.value ) {\n\t\t\treturn;\n\t\t}\n\t\tif ( ! this.props.gallery ) {\n\t\t\tconst selection = this.frame.state().get( 'selection' );\n\t\t\tcastArray( this.props.value ).map( ( id ) => {\n\t\t\t\tselection.add( wp.media.attachment( id ) );\n\t\t\t} );\n\t\t}\n\t\t// load the images so they are available in the media modal.\n\t\tgetAttachmentsCollection( castArray( this.props.value ) ).more();\n\t}\n\n\tonClose() {\n\t\tconst { onClose } = this.props;\n\n\t\tif ( onClose ) {\n\t\t\tonClose();\n\t\t}\n\t}\n\n\topenModal() {\n\t\tthis.frame.open();\n\t}\n\n\trender() {\n\t\treturn this.props.render( { open: this.openModal } );\n\t}\n}\n\nexport default MediaUpload;\n\n"]}